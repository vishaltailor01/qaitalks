name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  # Job 1: Validate HTML and run quality checks
  validate:
    name: Code Quality & Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install HTML validator
        run: npm install -g html-validate

      - name: Validate HTML files
        run: |
          echo "üîç Validating HTML files..."
          for file in site/public/**/*.html site/public/*.html; do
            if [ -f "$file" ]; then
              echo "Checking: $file"
              html-validate "$file" || true
            fi
          done

      - name: Check for broken links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          use-verbose-mode: 'no'
          max-depth: 2
          folder-path: 'site/public'

      - name: Verify required files exist
        run: |
          echo "üîç Checking required files..."
          required_files=(
            "site/public/index.html"
            "site/public/about.html"
            "site/public/curriculum.html"
            "site/public/blog.html"
            "site/public/branding/logo.svg"
            "site/public/branding/favicon.svg"
          )
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "‚úÖ $file exists"
            else
              echo "‚ùå $file MISSING"
              exit 1
            fi
          done

      - name: Check file sizes
        run: |
          echo "üìä File size report:"
          find site/public -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" -o -name "*.svg" \) -exec ls -lh {} \; | awk '{print $9, $5}'

  # Job 2: Run Lighthouse performance audit (production branch only)
  lighthouse:
    name: Lighthouse Audit
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: npm install -g lighthouse

      - name: Run local server
        run: |
          npx serve site/public -l 3000 &
          sleep 5

      - name: Run Lighthouse on homepage
        run: |
          echo "üöÄ Running Lighthouse audit on index.html..."
          lighthouse http://localhost:3000/index.html --chrome-flags="--headless --no-sandbox" --output-path=./results.json --output=json
          cat results.json | jq '.categories[] | {category: .id, score: .score}'

  # Job 3: Deploy to staging (develop branch)
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to Cloudflare Pages (staging)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy site/public --project-name=qaitalks --branch=develop

      - name: Comment on workflow
        run: |
          echo "‚úÖ Deployed to staging: https://develop.qaitalks.pages.dev"

  # Job 4: Deploy to production (main branch, requires validation + lighthouse)
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [validate, lighthouse]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to Cloudflare Pages (production)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy site/public --project-name=qaitalks --branch=main

      - name: Notify deployment success
        run: |
          echo "‚úÖ Successfully deployed to production!"
          echo "üåê Live at: https://qaitalks.com"
          echo "üìä Full deployment URL: https://main.qaitalks.pages.dev"

  # Job 5: Validate PR changes (only runs on pull requests)
  validate-pr:
    name: Validate Pull Request
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install tools
        run: npm install -g html-validate

      - name: Validate HTML changes
        run: |
          echo "üîç Validating HTML files in PR..."
          for file in site/public/**/*.html site/public/*.html; do
            if [ -f "$file" ]; then
              html-validate "$file" || true
            fi
          done

      - name: Show test results summary
        run: |
          echo "üìã PR Validation Summary:"
          echo "‚úÖ HTML validation passed"
          echo "‚úÖ File structure validated"
          echo ""
          echo "Next steps:"
          echo "1. Assign reviewer to PR"
          echo "2. Reviewer tests changes locally"
          echo "3. Merge to develop after approval"
