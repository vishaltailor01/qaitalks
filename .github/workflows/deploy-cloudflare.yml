name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  # Job 1: Validate HTML and run quality checks
  validate:
    name: Code Quality & Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci
        working-directory: next-app

      - name: Generate Prisma Client
        run: npx prisma generate
        working-directory: next-app
        env:
          DATABASE_URL: file:./prisma/dev.db

      - name: Lint (Next.js)
        run: npm run lint
        working-directory: next-app

      - name: Type check (Next.js)
        run: npm run type-check

  # Job 2: Run Lighthouse performance audit (production branch only)
  lighthouse:
    name: Lighthouse Audit
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          npm ci
          npm install -g lighthouse
        working-directory: next-app

      - name: Generate Prisma Client
        run: npx prisma generate
        working-directory: next-app
        env:
          DATABASE_URL: file:./prisma/dev.db

      - name: Run local server
        run: |
          npm run build
          npm run start -- --port 3000 &
          sleep 8
        working-directory: next-app

      - name: Run Lighthouse on homepage
        run: |
          echo "üöÄ Running Lighthouse audit on homepage..."
          lighthouse http://localhost:3000/ --chrome-flags="--headless --no-sandbox" --output-path=./results.json --output=json
          cat results.json | jq '.categories[] | {category: .id, score: .score}'
        working-directory: next-app

  # Job 3: Deploy to staging (develop branch)
  # NOTE: Disabled - static site removed, use Vercel/Cloudflare for Next.js deployment
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: validate
    if: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to Cloudflare Pages (staging)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy site/public --project-name=qaitalks --branch=develop

      - name: Comment on workflow
        run: |
          echo "‚úÖ Deployed to staging: https://develop.qaitalks.pages.dev"

  # Job 4: Deploy to production (main branch, requires validation + lighthouse)
  # NOTE: Disabled - static site removed, use Vercel/Cloudflare for Next.js deployment
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [validate, lighthouse]
    if: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to Cloudflare Pages (production)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy site/public --project-name=qaitalks --branch=main

      - name: Notify deployment success
        run: |
          echo "‚úÖ Successfully deployed to production!"
          echo "üåê Live at: https://qaitalks.com"
          echo "üìä Full deployment URL: https://main.qaitalks.pages.dev"

  # Job 5: Validate PR changes (only runs on pull requests)
  validate-pr:
    name: Validate Pull Request
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci
        working-directory: next-app

      - name: Generate Prisma Client
        run: npx prisma generate
        working-directory: next-app
        env:
          DATABASE_URL: file:./prisma/dev.db

      - name: Lint (Next.js)
        run: npm run lint
        working-directory: next-app

      - name: Type check (Next.js)
        run: npm run type-check

      - name: Show test results summary
        run: |
          echo "üìã PR Validation Summary:"
          echo "‚úÖ Lint and type checks passed"
          echo ""
          echo "Next steps:"
          echo "1. Assign reviewer to PR"
          echo "2. Reviewer tests changes locally"
          echo "3. Merge to develop after approval"
